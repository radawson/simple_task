{% extends 'base.html' %}

{% block title %}
Admin
{% endblock %}

{% block content %}

<main class="my-5 mx-3">
    <!-- Tabs navs -->
    <ul class="nav nav-tabs nav-justified mb-3" id="admin" role="tablist">
        <li class="nav-item" role="presentation">
            <a data-mdb-tab-init class="nav-link active" id="admin-tab-1" href="#admin-tabs-1" role="tab"
                aria-controls="admin-tabs-1" aria-selected="true">User Management</a>
        </li>
        <li class="nav-item" role="presentation">
            <a data-mdb-tab-init class="nav-link" id="admin-tab-2" href="#admin-tabs-2" role="tab"
                aria-controls="admin-tabs-2" aria-selected="false">Timecards</a>
        </li>
    </ul>
    <!-- Tabs navs -->
    <!-- Tabs content -->
    <div class="tab-content" id="admin-content">
        <div class="tab-pane fade show active" id="admin-tabs-1" role="tabpanel" aria-labelledby="admin-tab-1">
            <div class="d-flex justify-content-end mb-4">
                <div data-mdb-input-init class="form-outline">
                    <input data-mdb-search data-mdb-target="#table_inputs" type="text" id="search_table_inputs"
                        class="form-control" />
                    <label class="form-label" for="search_table_inputs">Search</label>
                </div>
                <button data-mdb-ripple-init class="btn btn-primary btn-sm ms-3" data-mdb-add-entry
                    data-mdb-target="#table_inputs">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
            <hr />
            <div id="table_inputs"></div>
        </div>
        <div class="tab-pane fade " id="admin-tabs-2" role="tabpanel" aria-labelledby="admin-tab-2">
            <div class="d-flex justify-content-end mb-4">
                <div data-mdb-input-init class="form-outline">
                    <input data-mdb-search data-mdb-target="#table_timecard" type="text" id="search_table_timecard"
                        class="form-control" />
                    <label class="form-label" for="search_table_timecard">Search</label>
                </div>
                <button data-mdb-ripple-init class="btn btn-primary btn-sm ms-3" data-mdb-add-entry
                    data-mdb-target="#table_timecard">
                    <i class="fa fa-plus"></i>
                </button>
            </div>
            <hr />
            <div id="table_timecard"></div>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-mdb-ripple-init data-mdb-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">Are you sure you want to delete this event?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-mdb-ripple-init
                        data-mdb-dismiss="modal">Cancel</button>
                    <button type="button" id="confirm_delete" class="btn btn-danger"
                        data-mdb-ripple-init>Delete</button>
                </div>
            </div>
        </div>
    </div>
</main>

{% endblock %}

{% block extra_js %}

<!-- MDB PLUGINS -->
<script type="text/javascript" src="{{url_for('static', filename='plugins/js/all.min.js')}}"></script>
<script>
    function fetchUsers() {
        let url = "{{ url_for('auth.get_users')}}";
        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                userTable.update(
                    {
                        rows: data.map((user) => ({
                            ...user,
                            first_name: user.first_name ? user.first_name : '',
                            last_name: user.last_name ? user.last_name : '',
                            base_pay: user.base_pay / 100,
                        })),
                    },
                    { loading: false }
                );
            });
    }

    function fetchTime(filter) {
        let url = "{{ url_for('times.time_by_date', date='all')}}";
        if (filter.person) {
            url = "{{ url_for('times.time_by_person', person_id=0)}}";
            url = url.replace('0', filter.person);
        };
        if (filter.date) {
            url = "{{ url_for('times.time_by_date', date=0)}}";
            url = url.replace('0', filter.date);
        };
        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                data = data.map((time) => {
                    if (time.first_name == null) {
                        time.full_name = `Person ID: ${time.person_id}`;
                    }
                    else if (time.last_name == null) {
                        time.full_name = `${time.first_name} ${time.person_id}`;
                    } else {
                        time.full_name = `${time.first_name} ${time.last_name}`;
                    }
                    time.base_pay = time.base_pay / 100;
                    time.actions = `
    <button data-mdb-ripple-init class="edit-btn btn btn-outline-primary btn-floating btn-sm" data-mdb-id="${time.id}" data-mdb-tooltip-init title="Edit"><i class="fa fa-edit"></i></button>
    <button data-mdb-ripple-init class="delete-btn btn btn-outline-primary btn-floating btn-sm" data-mdb-id="${time.id}"><i class="fa fa-trash" data-mdb-tooltip-init title="Delete"></i></button>`;
                    return time;
                });
                asyncTable.update(
                    {
                        rows: data.map((time) => ({
                            ...time,
                        })),
                    },
                    { loading: false }
                );
            });
    }

    // Tab 1

    const advancedColumns1 = [
        {
            label: 'First Name',
            field: 'first_name',
        },
        {
            label: 'Last Name',
            field: 'last_name',
        },
        {
            inputType: 'number',
            defaultValue: 18,
            label: 'Base Pay',
            field: 'base_pay',
        },
        {
            defaultValue: false,
            inputType: 'checkbox',
            label: 'Employee',
            field: 'employee',
        },
        {
            inputType: 'text',
            label: 'User Name',
            field: 'username',
        },
        {
            defaultValue: false,
            inputType: 'checkbox',
            label: 'Admin',
            field: 'admin',
        },
    ];


    const userTable = new TableEditor(
        document.getElementById('table_inputs'),
        { columns: advancedColumns1, },
        { entries: 5, entriesOptions: [5, 10, 15], confirm: true }
    );

    fetchUsers();

    document.getElementById('table_inputs').addEventListener('delete.mdb.tableEditor', (e) => {
        let formData = new FormData();
        let url = "{{ url_for('auth.user_api', user_id=0)}}";
        url = url.replace('0', e.row.id);
        fetch(url, {
            method: "DELETE"
        })
            .then(response => response.json())
            .then(data => {
                showAlert(data);
            })
            .catch(error => {
                console.error({ messager: error, category: 'danger' });
            })
            .finally(() => {
                fetchUsers();
            });
    })

    document.getElementById('table_inputs').addEventListener('update.mdb.tableEditor', (e) => {
        // here you can create a POST request to update your database
        let formData = new FormData();
        formData.append('first_name', e.row.first_name);
        formData.append('last_name', e.row.last_name);
        formData.append('base_pay', e.row.base_pay * 100);
        formData.append('employee', e.row.employee);
        formData.append('admin', e.row.admin);
        formData.append('id', e.row.id);
        let url = "{{ url_for('auth.user_api', user_id=0)}}";
        url = url.replace('0', e.row.id);
        fetch(url, {
            body: formData,
            method: "PATCH"
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                showAlert(data);
            })
            .catch(error => {
                console.error({ messager: error, category: 'danger' });
            });
    })

    // Tab 2
    const setActions = () => {
        Array.from(document.getElementsByClassName('edit-btn')).forEach(btn => {
            btn.addEventListener('click', () => {
                base_url = "{{ url_for('times.time_api', time_id=0) }}"
                url = base_url.replace('0', btn.attributes['data-mdb-id'].value);
                fetch(url, {
                    method: 'GET',
                })
                    .then(response => response.json())
                    // showAlert found in base.html
                    .then(data => showAlert(data))
                    .catch((error) => {
                        console.error('Error:', error);
                    })
            })
        })

        Array.from(document.getElementsByClassName('delete-btn')).forEach(btn => {
            btn.addEventListener('click', () => {
                let conf_modal = new mdb.Modal(document.getElementById('confirmModal'), {
                    keyboard: false
                });
                conf_modal.show();
                document.getElementById('confirmModalLabel').innerHTML = "Confirm Delete";
                document.getElementById('confirm_delete').addEventListener('click', () => {
                    let url = "{{ url_for('times.time_api', time_id=0) }}";
                    url = url.replace('0', btn.attributes['data-mdb-id'].value);
                    console.log("Deleting timecard entry using", url);

                    fetch(url, {
                        method: 'DELETE',
                    })
                        .then(response => response.json())
                        // showAlert found in base.html
                        .then(data => showAlert(data))
                        .catch((error) => {
                            console.error('Error:', error);
                        })

                });

            })
        })
    }


    document.getElementById('table_timecard').addEventListener('render.mdb.datatable', setActions);

    const timecardColumns = [
        {

            sort: true,
            label: 'Date',
            field: 'date',
        },
        {

            inputType: 'text',
            label: 'Employee',
            field: 'full_name',
        },
        {

            inputType: 'time',
            label: 'Time In',
            field: 'time_in',
        },
        {

            inputType: 'time',
            label: 'Time Out',
            field: 'time_out',
        },
        {

            inputType: 'number',
            label: 'Base Pay',
            field: 'base_pay',
        },

        {

            inputType: 'text',
            label: 'Notes',
            field: 'description',
        },
        {

            defaultValue: false,
            inputType: 'checkbox',
            label: 'Paid',
            field: 'paid',
        },
        {

            inputType: 'text',
            label: 'Actions',
            field: 'actions',
        },
    ];

    const asyncTable = new mdb.Datatable(
        document.getElementById('table_timecard'),
        { columns: timecardColumns, },
        {
            search: true,
            pagination: true,
            loading: true,
            striped: true,
            sortable: true,
            entries: 5,
            entriesOptions: [5, 15, 25],
            confirm: true
        }
    );

    fetchTime({ "person": "all" });
</script>
{% endblock %}